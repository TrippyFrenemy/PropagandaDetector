import logging
import random
import time

from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score

from pipelines.cascade_classification import CascadePropagandaPipeline
from pipelines.enhanced_cascade import EnhancedCascadePropagandaPipeline
from pipelines.enhanced_smote import EnhancedSmotePropagandaPipeline
from pipelines.improved_cascade import ImprovedCascadePropagandaPipeline
from utils.translate import check_lang_corpus, translate_corpus
from utils.draw_report import draw_report

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

logging.getLogger("pymorphy3").setLevel(logging.WARNING)

logger = logging.getLogger(__name__)


def result_output(predict, pipeline, text, pipeline_name, idx):
    # Initialize pipeline
    logger.info(f"Running predictions on test texts...\nVersion of {pipeline_name.upper()} PIPELINE v{idx}")
    results, formatted = pipeline.predict(text, True)

    binary_scores = [1 if result['propaganda_probability'] * 100 > 50 else 0 for result in results]
    scores = [round(result['propaganda_probability'] * 100) for result in results]

    matches = sum(1 for p, b in zip(predict, binary_scores) if p == b)
    total = len(predict)

    # Вычисляем точность
    accuracy = matches / total

    logger.info(f"Всего: {binary_scores}")
    logger.info(f"Совпадений: {matches}/{total}")
    logger.info(f"Точность: {accuracy:.2%}")

    # Дополнительная статистика
    true_positives = sum(1 for p, b in zip(predict, binary_scores) if p == 1 and b == 1)
    true_negatives = sum(1 for p, b in zip(predict, binary_scores) if p == 0 and b == 0)
    false_positives = sum(1 for p, b in zip(predict, binary_scores) if p == 0 and b == 1)
    false_negatives = sum(1 for p, b in zip(predict, binary_scores) if p == 1 and b == 0)

    logger.info(f"\nДетальная статистика:")
    logger.info(f"Правильно определена пропаганда (True Positives): {true_positives}")
    logger.info(f"Правильно определены чистые тексты (True Negatives): {true_negatives}")
    logger.info(f"Ложные срабатывания (False Positives): {false_positives}")
    logger.info(f"Пропущенная пропаганда (False Negatives): {false_negatives}")

    # Обчислення метрик
    accuracy = accuracy_score(predict, binary_scores)
    precision = precision_score(predict, binary_scores)
    recall = recall_score(predict, binary_scores)
    f1 = f1_score(predict, binary_scores)

    # Виведення результатів
    logger.info(f"Точність (Accuracy): {accuracy:.2%}")
    logger.info(f"Влучність (Precision): {precision:.2%}")
    logger.info(f"Повнота (Recall): {recall:.2%}")
    logger.info(f"F1-міра: {f1:.2%}")

    # Виклик draw_report для побудови та збереження матриці розсіювання
    title = f"Матриця розсіювання для {pipeline_name.upper()} PIPELINE v{idx}"
    file_name = f"{pipeline_name}_pipeline_v{idx}_confusion_matrix"
    extension = "jpg"
    draw_report(title, predict, binary_scores, file_name, extension)


def main():
    text_neut = [
        # Непропагандистські тексти (50)
        "Погода сьогодні сонячна, температура повітря сягає 25 градусів тепла.",
        "Національний банк України опублікував звіт щодо інфляції за останній квартал.",
        "У Києві відкрили нову станцію метро, яка з'єднує центр міста з околицями.",
        "Збірна України з футболу проведе товариський матч наступного тижня.",
        "Цього року урожай зернових культур перевищив показники минулого року на 15%.",
        "Нова виставка сучасного мистецтва триватиме в музеї до кінця місяця.",
        "Вартість проїзду в громадському транспорті зросла на 2 гривні з першого числа.",
        "Науковці з Харківського університету опублікували дослідження щодо якості питної води.",
        "У Львові пройде фестиваль джазової музики за участю музикантів з різних країн.",
        "Міністерство освіти оголосило дати проведення зовнішнього незалежного оцінювання.",
        "На ринку з'явилися сезонні ягоди, ціни варіюються від 30 до 50 гривень за кілограм.",
        "Реконструкція історичного центру міста завершиться до Дня Незалежності.",
        "Збільшення кількості опадів цієї весни позитивно вплинуло на рівень ґрунтових вод.",
        "Фахівці рекомендують обрізати плодові дерева в саду до початку березня.",
        "Нова екранізація твору української літератури вийде на екрани кінотеатрів у травні.",
        "Служба статистики оприлюднила дані щодо зростання ВВП у минулому році.",
        "На озері Світязь зафіксували збільшення популяції рідкісних птахів.",
        "В університеті відбудеться науково-практична конференція з питань екології.",
        "Вчителі загальноосвітніх шкіл пройдуть курси підвищення кваліфікації.",
        "Дорожні служби завершили ремонт мосту через річку Дніпро.",
        "Заповідник 'Асканія-Нова' збагатився новими видами рослин цього сезону.",
        "У столиці відкрився новий торговельний центр із магазинами українських брендів.",
        "Вартість оренди житла в центральних районах міста збільшилась на 10%.",
        "За даними спостережень, цього року птахи повернулися з вирію на два тижні раніше.",
        "Проїзд платними дорогами тепер можна оплачувати за допомогою мобільного додатку.",
        "Переможці олімпіади з фізики отримають стипендії для навчання в університеті.",
        "У міській бібліотеці проведуть зустріч з відомим українським письменником.",
        "Будівництво нового корпусу лікарні планують завершити до кінця року.",
        "Фермери південних областей розпочали збір ранніх овочів.",
        "У столичних школах запровадили електронні щоденники для учнів.",
        "Виробники органічної продукції представили свої товари на щорічному ярмарку.",
        "Експерти прогнозують збільшення туристичного потоку до карпатських курортів.",
        "Результати дослідження якості повітря в промислових містах опубліковані в науковому журналі.",
        "На центральній площі міста встановили новий годинник.",
        "Згідно з даними лікарів, кількість хворих на грип почала зменшуватися.",
        "Бджолярі зібрали перший весняний мед у південних регіонах країни.",
        "Розклад руху приміських поїздів змінився з першого травня.",
        "Лісники висадили 5000 саджанців дуба в рамках програми відновлення лісів.",
        "У Дніпрі відбулися змагання з плавання серед юніорів.",
        "Археологи знайшли артефакти часів Київської Русі під час розкопок.",
        "Місцева влада оновила дитячі майданчики в п'яти парках міста.",
        "Кінофестиваль короткометражних фільмів приймає заявки від молодих режисерів.",
        "Астрономи запрошують усіх бажаючих спостерігати за метеоритним дощем цієї ночі.",
        "Гідрометцентр попереджає про можливі заморозки в нічний час.",
        "Виробники молочної продукції презентували нову лінійку товарів без лактози.",
        "Міжнародна конференція з кібербезпеки відбудеться наступного місяця в Одесі.",
        "Дорожня служба закликає водіїв бути уважними через ремонтні роботи на трасі.",
        "Нові правила паркування набудуть чинності з початку наступного місяця.",
        "Споживання електроенергії в країні зменшилося на 5% порівняно з минулим роком.",
        "Сьогодні гарна погода для прогулянки.",
        "Місто розвивається швидкими темпами.",
        "Цього року врожай картоплі був кращим, ніж минулого.",
        "Музика позитивно впливає на настрій.",
        "Читання книг розширює світогляд.",
        "Наука та техніка змінюють наше життя.",
        "Швидкісний інтернет доступний у багатьох містах.",
        "Освіта відіграє важливу роль у суспільстві.",
        "Сучасні технології допомагають економити час.",
        "Здоровий спосіб життя сприяє довголіттю.",
    ]

    text_prop = [
        # Пропагандистські тексти (50)
        "Наша країна — єдина сила добра у світі, що протистоїть силам хаосу та зла!",
        "Вороги нашої держави знову готують підступний план проти нашого народу!",
        "Тільки нинішній уряд здатний вивести нашу країну з багаторічної кризи!",
        "Наші сусіди заздрять нашим успіхам і хочуть знищити все, що ми будували століттями!",
        "Патріоти підтримують цей закон, а зрадники виступають проти нього!",
        "Їхні ЗМІ брешуть, а наші розповідають правду про справжній стан речей!",
        "Наші діди не для того проливали кров, щоб ми зараз здавали наші національні інтереси!",
        "Опозиція діє за вказівкою закордонних кураторів, які хочуть розвалити нашу державу!",
        "Ця реформа — тріумф нашої економіки, незважаючи на те, що кажуть так звані 'експерти'!",
        "Тільки ми маємо волю та силу захистити нашу національну ідентичність від глобалізму!",
        "Хто не з нами — той проти нас! Третього шляху не існує у боротьбі за майбутнє!",
        "Наші вороги тремтять від страху, спостерігаючи за нашим стрімким розвитком!",
        "Громадяни, які критикують владу, є національними зрадниками та агентами впливу!",
        "Наша армія — найсильніша в регіоні, ніхто не наважиться кинути нам виклик!",
        "Західні країни хочуть знищити нашу економіку своїми санкціями та підступними діями!",
        "Ми нікому не дозволимо вказувати, як нам жити і якою має бути наша внутрішня політика!",
        "Наша партія — єдина політична сила, яка по-справжньому дбає про інтереси народу!",
        "Ми повинні об'єднатися навколо нашого лідера, який єдиний знає шлях до процвітання!",
        "Так звані 'демократичні цінності' — це інструмент для підкорення нашого народу!",
        "Наші духовні цінності під загрозою через наступ чужої ідеології та морального розкладу!",
        "Ті, хто виступає проти традиційних цінностей, є ворогами нашого народу і майбутнього!",
        "Наші діти повинні знати, що ми — найвеличніша нація з героїчною історією!",
        "Олігархи та міжнародні корпорації хочуть викрасти наші природні ресурси!",
        "Націонал-зрадники намагаються розколоти суспільство своїми провокаційними заявами!",
        "Наші вчені довели, що їхні теорії — це лише спроба підірвати основи нашої науки!",
        "Молодь має бути готова віддати життя за наші священні ідеали та цінності!",
        "Їхня 'свобода слова' — це свобода поширювати брехню і розпалювати ненависть!",
        "Справжній патріот ніколи не критикуватиме владу у скрутні для країни часи!",
        "Тільки наш народ має історичне право на ці території, які намагаються відібрати вороги!",
        "Світові ЗМІ навмисно замовчують наші великі досягнення та приховують правду!",
        "Наша нація обрана самою історією для великої місії в цивілізаційному протистоянні!",
        "Проти нас ведеться інформаційна війна, але ми знаємо правду і не піддамося на провокації!",
        "Нашу мову та культуру намагаються знищити вороги нашої державності!",
        "Скоро всі зрозуміють велич нашого шляху і пошкодують, що сумнівалися в нас!",
        "Наша особлива духовність і моральність є прикладом для всього світу!",
        "Так звані 'правозахисники' працюють на іноземні спецслужби, а не захищають права громадян!",
        "Нам потрібна сильна рука, щоб навести лад і припинити хаос, спровокований зовнішніми силами!",
        "Наша економічна модель унікальна і набагато ефективніша за західний капіталізм!",
        "Історія доведе правоту нашого вибору, а критики будуть посоромлені своїми звинуваченнями!",
        "Міжнародні організації упереджено ставляться до нашої країни і не визнають наші досягнення!",
        "Ми самі вирішимо наші внутрішні проблеми без втручання іноземних радників!",
        "Наш народ ніколи не стане на коліна перед агресорами, як це зробили інші слабкі нації!",
        "Священний обов'язок кожного громадянина — захищати нашу ідеологію від будь-яких нападок!",
        "Єдність і безумовна підтримка влади — запорука нашої перемоги над внутрішніми і зовнішніми ворогами!",
        "Наші опоненти використовують брудні технології, щоб дискредитувати наші великі досягнення!",
        "Народ, який не пам'ятає своїх героїв, приречений на загибель під натиском чужої культури!",
        "Тільки повне єднання нації навколо нашої ідеології врятує нас від зовнішніх загроз!",
        "Кожен, хто виступає проти національних інтересів, заслуговує на суворе покарання!",
        "Наша система освіти має виховувати справжніх патріотів, а не космополітів без роду і племені!",
        "Єдина правильна ідеологія веде нас до світлого майбутнього!",
        "Лише наша країна здатна принести справжній порядок у світ!",
        "Засоби масової інформації приховують правду, але ми відкриємо очі людям!",
        "Наш лідер – наймудріший керівник у світовій історії!",
        "Ми єдина нація, що має право керувати іншими!",
        "Зовнішні сили намагаються зруйнувати наші традиції!",
        "Тільки наша партія здатна врятувати країну від занепаду!",
        "Ми маємо бути готові пожертвувати всім заради великої мети!",
        "Опозиція – це лише інструмент наших ворогів!",
        "Ми маємо зміцнювати свою могутність за будь-яку ціну!"
    ]

    random.shuffle(text_neut)
    random.shuffle(text_prop)

    predict = [0] * len(text_neut) + [1] * len(text_prop)
    text_ua = text_neut + text_prop
    logger.info(predict, len(text_ua))

    for idx in range(1, 2):
        try:
            pipeline = EnhancedCascadePropagandaPipeline(
                model_path="../models",
                model_name=f"ecpm_ua_v{idx}",
                batch_size=32,
                num_epochs_binary=20,
                num_epochs_technique=10,
                learning_rate=2e-5,
                warmup_steps=1000,
                max_length=512,
                class_weights=True,
                use_ukrainian=True
            )

            result_output(predict, pipeline, text_ua, "UA", idx)

        except Exception as e:
            logger.error(f"Prediction failed: {str(e)}")

    text_neut = translate_corpus(text_neut)
    text_prop = translate_corpus(text_prop)

    text = text_neut + text_prop

    for idx in range(1, 2):
        try:
            pipeline = EnhancedSmotePropagandaPipeline(
                model_path="../models",
                model_name=f"ecpm_smote_v{idx}",
                batch_size=32,
                num_epochs_binary=20,
                num_epochs_technique=10,
                learning_rate=2e-5,
                warmup_steps=1000,
                max_length=512,
                class_weights=True,
            )

            result_output(predict, pipeline, text, "Smote", idx)

        except Exception as e:
            logger.error(f"Prediction failed: {str(e)}")

    for idx in range(1, 4):
        try:
            pipeline = EnhancedCascadePropagandaPipeline(
                model_path="../models",
                model_name=f"ecpm_v{idx}",
                batch_size=32,
                num_epochs_binary=20,
                num_epochs_technique=10,
                learning_rate=2e-5,
                warmup_steps=1000,
                max_length=512,
                class_weights=True,
            )

            result_output(predict, pipeline, text, "Enhanced", idx)

        except Exception as e:
            logger.error(f"Prediction failed: {str(e)}")

    for idx in range(2, 6):
        try:
            binary_k_range = [3, 4, 5] if idx < 5 else [3, 5, 7]
            technique_k_range = [2, 3, 4, 5] if idx < 5 else [3, 5]

            pipeline = CascadePropagandaPipeline(
                model_path="../models",
                model_name=f"cpm_v{idx}",
                batch_size=32,
                num_epochs_binary=10,
                num_epochs_technique=10,
                learning_rate=2e-5,
                warmup_steps=1000,
                max_length=512,
                class_weights=True,
                binary_k_range=binary_k_range,
                technique_k_range=technique_k_range,
            )

            result_output(predict, pipeline, text, "Cascade", idx)

        except Exception as e:
            logger.error(f"Prediction failed: {str(e)}")

    for idx in range(1, 2):
        try:
            binary_k_range = [3, 4, 5] if idx < 3 else [3, 5, 7]
            technique_k_range = [2, 3, 4, 5] if idx < 3 else [3, 5]
            pipeline = ImprovedCascadePropagandaPipeline(
                model_path="../models",
                model_name=f"icpm_v{idx}",
                batch_size=32,
                num_epochs_binary=10,
                num_epochs_technique=10,
                learning_rate=2e-5,
                warmup_steps=1000,
                max_length=512,
                class_weights=True,
                binary_k_range=binary_k_range,
                technique_k_range=technique_k_range,
            )

            result_output(predict, pipeline, text, "Improved", idx)

        except Exception as e:
            logger.error(f"Prediction failed: {str(e)}")


if __name__ == '__main__':
    main()
